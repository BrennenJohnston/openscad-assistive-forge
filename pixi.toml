# Pixi environment configuration for OpenSCAD Assistive Forge
# https://pixi.sh/
#
# Optional: This file provides reproducible environment setup via pixi.
# The project works fine with standard npm commands - pixi is not required.
#
# To use pixi:
#   1. Install pixi: https://pixi.sh/latest/#installation
#   2. Run `pixi install` to set up the environment
#   3. Run tasks with `pixi run <task>`

[project]
name = "openscad-assistive-forge"
version = "4.1.0"
description = "Accessibility-first web-based OpenSCAD customizer"
channels = ["conda-forge"]
platforms = ["win-64", "linux-64", "osx-64", "osx-arm64"]

[dependencies]
nodejs = ">=20"

[tasks]
# Development
dev = { cmd = "npm run dev", description = "Start Vite dev server with hot reload on http://localhost:5173" }
build = { cmd = "npm run build", description = "Build production bundle to dist/ with minification and tree-shaking" }
preview = { cmd = "npm run preview", description = "Serve the production build locally for pre-deploy verification" }

# Testing
test = { cmd = "npm run test:run", description = "Run Vitest unit tests once and exit" }
"test:watch" = { cmd = "npm run test:watch", description = "Run Vitest in watch mode, re-running on file changes" }
"test:e2e" = { cmd = "npm run test:e2e", description = "Run Playwright end-to-end tests (requires dev server running)" }
"test:all" = { cmd = "npm run test:all", description = "Run unit tests then E2E tests sequentially" }
"test:coverage" = { cmd = "npm run test:coverage", description = "Run unit tests with code coverage report" }
"test:ui" = { cmd = "npm run test:ui", description = "Run Vitest with interactive browser UI" }
"test:e2e:headed" = { cmd = "npm run test:e2e:headed", description = "Run Playwright E2E tests in headed browser mode" }
"test:e2e:debug" = { cmd = "npm run test:e2e:debug", description = "Run Playwright E2E tests in debug mode with inspector" }
"test:visual" = { cmd = "npm run test:visual", description = "Run visual regression tests comparing screenshots" }
"test:visual:update" = { cmd = "npm run test:visual:update", description = "Update visual regression test snapshots" }

# Code quality
lint = { cmd = "npm run lint", description = "Run ESLint on src/ to check for code quality issues" }
format = { cmd = "npm run format", description = "Run Prettier to auto-format all source files" }
"format:check" = { cmd = "npm run format:check", description = "Check if all source files match Prettier formatting (no writes)" }

# Setup
setup = { depends-on = ["setup-deps", "setup-wasm", "setup-libraries"], description = "Full first-time setup: install npm deps, download WASM binary, and fetch libraries" }
"setup-deps" = { cmd = "npm ci", description = "Install npm dependencies via npm ci (clean install)" }
"setup-wasm" = { cmd = "npm run setup-wasm", description = "Download the OpenSCAD WASM binary to public/" }
"setup-libraries" = { cmd = "npm run setup-libraries", description = "Fetch and install OpenSCAD libraries to public/libraries/" }

# Utilities
clean = { cmd = "rm -rf dist node_modules/.vite", description = "Clean build artifacts" }
"check-a11y" = { cmd = "npm run check-a11y", description = "Run Lighthouse accessibility audit against the dev server (requires server running)" }
"check-bundle" = { cmd = "npm run check-bundle", description = "Check production bundle sizes against budget limits" }
"validate:html" = { cmd = "npm run validate:html", description = "Run W3C Nu HTML/CSS/SVG validation on index.html" }
"validate:html:built" = { cmd = "npm run validate:html:built", description = "Run W3C Nu HTML/CSS/SVG validation on built dist/index.html" }
"bloat-scan" = { cmd = "npm run bloat-scan", description = "Scan src/ for AI-specific code and doc bloat patterns" }
"import-check" = { cmd = "npm run import-check", description = "Check that all import/require statements resolve to real files or packages" }

[feature.ci.tasks]
# CI-specific tasks
ci = { cmd = "npm run test:run && npm run build", description = "CI pipeline: run unit tests, then build production bundle" }

[environments]
default = { features = [], solve-group = "default" }
ci = { features = ["ci"], solve-group = "default" }
