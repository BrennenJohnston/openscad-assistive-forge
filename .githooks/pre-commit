#!/bin/bash
# Pre-commit hook: Scans staged files for forbidden stakeholder terms
# Install: git config core.hooksPath .githooks

FORBIDDEN_PATTERNS="volkswitch|volksswitch|Ken's P[0-9]|Ken @|stakeholder Ken|volksswitch\.org"

# Files that legitimately contain the forbidden terms (scanners, config, changelog)
EXCLUDED_FILES=".githooks/pre-commit|.github/workflows/stakeholder-scan.yml"

# Get staged files (excluding .volkswitch/ directory and binary files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -v "^\.volkswitch/")

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FOUND=0
for FILE in $STAGED_FILES; do
  # Skip excluded files (the scanners themselves)
  if echo "$FILE" | grep -qE "^($EXCLUDED_FILES)$"; then
    continue
  fi

  # Skip binary files
  if file --mime "$FILE" 2>/dev/null | grep -q "binary"; then
    continue
  fi

  # Filter out acceptable .volkswitch directory references before checking
  MATCHES=$(grep -iEn "$FORBIDDEN_PATTERNS" "$FILE" 2>/dev/null | grep -iv "\.volkswitch" | grep -iv "volkswitch-keyguard.*renamed\|volkswitch-keyguard.*becomes\|volkswitch-workflow.*renamed")
  if [ -n "$MATCHES" ]; then
    echo "ERROR: Forbidden stakeholder reference found in $FILE:"
    echo "$MATCHES"
    echo ""
    FOUND=1
  fi
done

if [ $FOUND -ne 0 ]; then
  echo "=========================================="
  echo "COMMIT REJECTED: Stakeholder references detected."
  echo "Replace with generic, feature-descriptive language."
  echo ""
  echo "Acceptable exceptions (not flagged):"
  echo "  - .volkswitch/ directory paths (gitignored local fixtures)"
  echo "  - Scanner files (.githooks/pre-commit, stakeholder-scan.yml)"
  echo "  - CHANGELOG entries documenting the rename"
  echo "=========================================="
  exit 1
fi

exit 0
